<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
	background: #f9f9f9;
	font: 12px "Helvetica Neue", Helvetica, Arial, sans-serif;
	color: #292929;
}

pre, svg {
  float: left;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: none;
  opacity: 0.5;
}

</style>
<body>
<h2>Dew Point/Temperature Timeline</h2>
<p>A graph of temperature (red) and dew point (blue) across <span id="sensor-num">(num)</span> NWS sensors in the Lake Tahoe region for the past week.</p>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script>
var stations = [];
var stationHistory = {};

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.time.scale()
    .range([0, width])
    .domain([d3.time.week.offset(new Date(), -1), new Date()]);

var y = d3.scale.linear()
    .range([height, 0])
    .domain([-20, 80]);

var color = d3.scale.ordinal()
  .range(["#b2182b", "#2166ac"]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var output = d3.select("body").append("pre")
  .style("margin", "0 0 0 20px");

svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("Date");

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", 6)
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "start")
      .text("Dew point/Temperature")

queue()
    .defer(d3.json, "http://stamen-simple-cors.herokuapp.com/nws-current/?extents=38.5,-120.5,39.5,-119.6")
    .await(ready);

function ready(error, sensors) {
  if (error) throw error;

  d3.select("#sensor-num").text(sensors.stations.length);

  sensors.stations.forEach(function(station) {
    loadStationHistory(station.id, 168, function(err, rsp) {
      stationHistory[station.id] = rsp;
      rsp.observations.forEach(function(d) {
        if ("Temp" in d)  {
          svg.append("circle")
              .attr("class", "dot")
              .attr("r", 1.25)
              .attr("cx", x(new Date(+d.Udate * 1000)))
              .attr("cy", y(d.Temp))
              .style("fill", color("Temp"))
              .on("mouseover", function() {
                var out = {
                  data: d,
                  station: station
                };
                output.text(JSON.stringify(out,undefined,2));
              });
        }
        if ("Dewp" in d)  {
          svg.append("circle")
              .attr("class", "dot")
              .attr("r", 1.25)
              .attr("cx", x(new Date(+d.Udate * 1000)))
              .attr("cy", y(d.Dewp))
              .style("fill", color("Dewp"))
              .on("mouseover", function() {
                var out = {
                  data: d,
                  station: station
                };
                output.text(JSON.stringify(out,undefined,2));
              });
        }
      });
    });
  });

}

/**
 * Load 10-min increments of historical observations for a station
 * Note: NWS data requests must go through a CORS proxy, e.g. https://github.com/ericsoco/simpleCORS
 */
function loadStationHistory (stationId, numHours, cb) {
	numHours = numHours || 168;		// one week
	// http://www.wrh.noaa.gov/mesowest/getobextJson.php?sid=ZEPNV&num=168
	d3.json('http://stamen-simple-cors.herokuapp.com/nws-historical/?sid='+ stationId +'&num='+ numHours, function (err, rsp) {
		cb(err, rsp);
	});
}

</script>

